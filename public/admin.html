<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TekeTeke – Admin (Starter)</title>
  <style>
    :root{ --brand:#0ea5e9; --ink:#0b0b0c; --bg:#f6fbff; --panel:#fff; --muted:#6b7280; --ok:#065f46; --bad:#b91c1c; --border:#e5e7eb; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,Arial,sans-serif;color:var(--ink)}
    header{background:var(--brand);color:#fff;padding:16px 20px;font-weight:700}
    main{max-width:1000px;margin:24px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 4px 16px rgba(2,132,199,.08)}
    h2{margin:0 0 10px}
    form{display:grid;gap:8px;margin-top:8px}
    input,button{padding:10px 12px;border-radius:10px;border:1px solid var(--border)}
    button{background:var(--brand);color:#fff;border:none;font-weight:600;cursor:pointer}
    .secondary{background:#111827;color:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#e0f2fe;color:#075985;font-size:.85rem}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .copybtn{margin-left:8px;padding:6px 10px;border-radius:8px;background:#111827;color:#fff;border:none;cursor:pointer;font-size:.85rem}
    .toast{position:fixed;right:16px;top:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transition:opacity .2s, transform .2s;transform:translateY(-10px);z-index:1000}
    .toast.show{opacity:1;transform:translateY(0)}
    .action-btn{border-radius:8px;background:var(--brand);color:#fff}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .actions button{padding:6px 10px;font-size:.8rem;font-weight:500}
    .actions button.secondary{background:#111827}
    .actions button.danger{background:#b91c1c}
  </style>
</head>
<body>
  <header>TekeTeke – Admin (Starter)</header>
  <main>
    <div class="card" id="session_card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <strong>Session</strong>
        <button class="secondary" type="button" onclick="logout()">Logout</button>
      </div>
    </div>
    

    <div class="card">
      <h2>Register Matatu</h2>
      <div class="muted">Till and USSD are captured automatically after saving.</div>
      <form onsubmit="return createMatatu(event)">
        <div class="row">
          <input id="plate" placeholder="Number plate (e.g., KDA 123A)" required />
          <input id="name" placeholder="Display name (optional)" />
        </div>
        <div class="row">
          <input id="till" placeholder="Till number" required />
          <input id="sacco" placeholder="SACCO name (optional)" />
        </div>
        <button>Create / Update</button>
      </form>
    </div>

    <div class="card">
      <h2>Matatus & Success Counts</h2>
      <button class="secondary" onclick="loadMatatus()">Refresh List</button>
      <div style="height:8px"></div>
      <table id="tbl">
        <thead>
          <tr>
            <th>ID</th>
            <th>Plate</th>
            <th>Till</th>
            <th>USSD</th>
            <th>Dial</th>
            <th>Success</th>
            <th>Last Tx</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </main>

  <div id="toast" class="toast">Copied!</div>

  <script>
    // USSD root is fetched from backend config to avoid drift
    let UI_USSD_ROOT = '123';
    const $ = (id)=>document.getElementById(id);

    

    function showToast(msg){
      const t = $('toast');
      t.textContent = msg || 'Done';
      t.classList.add('show');
      clearTimeout(window.__toast);
      window.__toast = setTimeout(()=> t.classList.remove('show'), 1200);
    }

    async function api(path, opts={}){
      const headers = Object.assign({ 'content-type':'application/json' }, opts.headers||{});
      const res = await fetch(path, Object.assign(opts, { headers }));
      const body = await res.json().catch(()=>({}));
      if (!res.ok) throw new Error(body.error || res.statusText);
      return body;
    }

    async function ensureAuth(){
      try {
        const r = await fetch('/api/auth/me');
        if (!r.ok) throw new Error('unauthorized');
        return true;
      } catch(_) {
        window.location.href = '/login.html';
        return false;
      }
    }

    async function logout(){
      try { await fetch('/api/auth/logout', { method: 'POST' }); } catch(_) {}
      window.location.href = '/login.html';
    }

    async function createMatatu(e){
      e.preventDefault();
      const plate = $('plate').value.trim();
      const name = $('name').value;
      const sacco = $('sacco').value;
      const tillNumber = $('till').value.trim();
      if (!tillNumber) {
        showToast('Till number is required');
        return false;
      }

      const payload = { plate, name, sacco_name: sacco };
      const out = await api('/api/matatus', { method:'POST', body: JSON.stringify(payload) });
      const id = out.matatu.id;

      let tillSaved = null;
      let dial = null;

      try {
        await saveTill(id, tillNumber);
        tillSaved = tillNumber;
      } catch (err) {
        console.error('Failed to save till', err);
      }

      try {
        const alloc = await allocateUssd(id);
        dial = alloc && alloc.dial ? alloc.dial : null;
      } catch (err) {
        console.error('Failed to allocate USSD code', err);
      }

      await loadMatatus();
      $('plate').value = '';
      $('name').value = '';
      $('sacco').value = '';
      $('till').value = '';

      const parts = ['Saved'];
      if (tillSaved) parts.push(`Till ${tillSaved}`);
      if (dial) parts.push(`Dial ${dial}`);
      showToast(parts.join(' • '));
      return false;
    }

    async function saveTill(matatuId, till_number){
      if(!matatuId || !till_number) throw new Error('Matatu ID and till are required');
      return api(`/api/matatus/${matatuId}/till`, { method:'POST', body: JSON.stringify({ till_number }) });
    }

    async function saveTill(matatuId, till_number){
      if(!matatuId || !till_number) throw new Error('Matatu ID and till are required');
      return api(`/api/matatus/${matatuId}/till`, { method:'POST', body: JSON.stringify({ till_number }) });
    }

    async function allocateUssd(matatuId){
      if(!matatuId) return null;
      return api(`/api/matatus/${matatuId}/ussd`, { method:'POST' });
    }

    function copyDialText(text){
      if(!text) return;
      navigator.clipboard.writeText(text).then(()=> showToast('Copied'));
    }

    async function loadMatatus(){
      const out = await api('/api/matatus');
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';

      (out.items || []).forEach(x=>{
        const tr = document.createElement('tr');

        const tdId = document.createElement('td'); tdId.className='mono'; tdId.textContent = x.matatu_id || '';
        const tdPlate = document.createElement('td'); tdPlate.className='mono'; tdPlate.textContent = x.plate || '';
        const tdTill = document.createElement('td'); tdTill.className='mono'; tdTill.textContent = x.till_number || '';
        const tdUssd = document.createElement('td'); tdUssd.className='mono'; tdUssd.textContent = x.ussd_code || '';

        const tdDial = document.createElement('td'); tdDial.className='mono';
        const dial = x.ussd_code ? (`*${UI_USSD_ROOT}*${x.ussd_code}#`) : '';
        if (dial) {
          const span = document.createElement('span'); span.textContent = dial;
          const btn = document.createElement('button'); btn.className='copybtn'; btn.type='button'; btn.textContent='Copy';
          btn.addEventListener('click', ()=> copyDialText(dial));
          tdDial.appendChild(span);
          tdDial.appendChild(btn);
        }

        const tdSucc = document.createElement('td'); tdSucc.innerHTML = `<span class="pill">${x.total_success || 0}</span>`;
        const tdLast = document.createElement('td'); tdLast.className='mono'; tdLast.textContent = x.last_tx_at || '';

        const tdActions = document.createElement('td'); tdActions.className='actions';
        tdActions.appendChild(actionButton('Change Till', () => changeTill(x)));
        tdActions.appendChild(actionButton('New USSD', () => reassignUssd(x), 'secondary'));
        tdActions.appendChild(actionButton('Delete', () => deleteMatatu(x), 'danger'));

        tr.appendChild(tdId);
        tr.appendChild(tdPlate);
        tr.appendChild(tdTill);
        tr.appendChild(tdUssd);
        tr.appendChild(tdDial);
        tr.appendChild(tdSucc);
        tr.appendChild(tdLast);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    function actionButton(label, handler, extraClass){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = label;
      btn.className = extraClass ? `action-btn ${extraClass}` : 'action-btn';
      btn.addEventListener('click', handler);
      return btn;
    }

    async function changeTill(matatu){
      const current = matatu.till_number || '';
      const next = prompt(`Enter new till for ${matatu.plate}`, current);
      if (next == null) return;
      const trimmed = next.trim();
      if (!trimmed) return;
      if (trimmed === current) return;
      await saveTill(matatu.matatu_id, trimmed);
      showToast('Till updated');
      await loadMatatus();
    }

    async function reassignUssd(matatu){
      if (!confirm(`Generate a new USSD code for ${matatu.plate}?`)) return;
      const out = await api(`/api/matatus/${matatu.matatu_id}/ussd/reassign`, { method:'POST' });
      showToast(`New USSD ${out.dial}`);
      await loadMatatus();
    }

    async function deleteMatatu(matatu){
      if (!confirm(`Delete matatu ${matatu.plate || ''}? This cannot be undone.`)) return;
      await api(`/api/matatus/${matatu.matatu_id}`, { method:'DELETE' });
      showToast('Matatu deleted');
      await loadMatatus();
    }

    async function fetchConfig(){
      try {
        const res = await fetch('/api/config');
        const cfg = await res.json().catch(()=>({}));
        if (cfg && cfg.ussd_root) UI_USSD_ROOT = String(cfg.ussd_root);
      } catch(_){ /* ignore */ }
    }

    // autoload
    (async function init(){
      if(!(await ensureAuth())) return;
      await fetchConfig();
      loadMatatus();
    })();
  </script>
</body>
</html>
